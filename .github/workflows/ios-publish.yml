name: iOS Build & Publish to App Store

on:
  workflow_dispatch:
    inputs:
      skip_waiting_for_build_processing:
        description: 'Skip waiting for build processing'
        required: false
        default: false
        type: boolean
  push:
    tags:
      - 'v*.*.*' # Trigger on version tags like v1.0.0

jobs:
  build-and-publish:
    name: Build & Publish to App Store
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install --repo-update

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Setup Code Signing
        id: setup_signing
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD || 'github-actions' }}
        run: |
          if [ -z "$APPLE_CERTIFICATE_BASE64" ] || [ -z "$APPLE_PROVISIONING_PROFILE_BASE64" ]; then
            echo "âš ï¸ Code signing credentials not configured, building without signing"
            echo "signing_enabled=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Code signing credentials found"
            echo "signing_enabled=true" >> $GITHUB_OUTPUT
            
            # Create keychain
            security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
            security set-keychain-settings -t 3600 -u build.keychain
            
            # Import certificate
            echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > certificate.p12
            security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign || true
            security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain || true
            
            # Import provisioning profile
            echo "$APPLE_PROVISIONING_PROFILE_BASE64" | base64 --decode > profile.mobileprovision
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            UUID=$(grep -aA1 UUID profile.mobileprovision | grep -o "[-A-Z0-9]\{36\}")
            cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
            
            # Clean up
            rm certificate.p12 profile.mobileprovision
          fi

      - name: Build iOS Archive
        env:
          CODE_SIGN_IDENTITY: ${{ secrets.APPLE_CODE_SIGN_IDENTITY || 'Apple Distribution' }}
          PROVISIONING_PROFILE_SPECIFIER: ${{ secrets.APPLE_PROVISIONING_PROFILE_SPECIFIER || '' }}
          SIGNING_ENABLED: ${{ steps.setup_signing.outputs.signing_enabled }}
        run: |
          cd ios
          if [ "$SIGNING_ENABLED" == "true" ]; then
            xcodebuild clean archive \
              -workspace JackMarvelsApp.xcworkspace \
              -scheme JackMarvelsApp \
              -configuration Release \
              -destination 'generic/platform=iOS' \
              -archivePath $PWD/build/JackMarvelsApp.xcarchive \
              CODE_SIGN_IDENTITY="$CODE_SIGN_IDENTITY" \
              CODE_SIGNING_REQUIRED=YES \
              CODE_SIGNING_ALLOWED=YES \
              PROVISIONING_PROFILE_SPECIFIER="$PROVISIONING_PROFILE_SPECIFIER"
          else
            xcodebuild clean archive \
              -workspace JackMarvelsApp.xcworkspace \
              -scheme JackMarvelsApp \
              -configuration Release \
              -destination 'generic/platform=iOS' \
              -archivePath $PWD/build/JackMarvelsApp.xcarchive \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO
          fi

      - name: Export IPA
        if: steps.setup_signing.outputs.signing_enabled == 'true'
        env:
          EXPORT_METHOD: ${{ secrets.APPLE_EXPORT_METHOD || 'app-store' }}
        run: |
          cd ios
          # Create ExportOptions.plist
          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>$EXPORT_METHOD</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_TEAM_ID }}</string>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath $PWD/build/JackMarvelsApp.xcarchive \
            -exportPath $PWD/build/export \
            -exportOptionsPlist ExportOptions.plist

      - name: Upload iOS Archive
        uses: actions/upload-artifact@v4
        with:
          name: ios-archive-release
          path: ios/build/JackMarvelsApp.xcarchive
          retention-days: 30

      - name: Upload IPA
        if: steps.setup_signing.outputs.signing_enabled == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-release
          path: ios/build/export/JackMarvelsApp.ipa
          retention-days: 30

      - name: Validate App Store Connect credentials
        id: validate_appstore_credentials
        run: |
          if [ -z "${{ secrets.APPLE_ISSUER_ID }}" ] || [ -z "${{ secrets.APPLE_KEY_ID }}" ] || [ -z "${{ secrets.APPLE_PRIVATE_KEY }}" ]; then
            echo "âš ï¸ App Store Connect API credentials not configured"
            echo "publish_enabled=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… App Store Connect API credentials found"
            echo "publish_enabled=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to App Store Connect (TestFlight)
        if: steps.validate_appstore_credentials.outputs.publish_enabled == 'true' && steps.setup_signing.outputs.signing_enabled == 'true'
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: ios/build/export/JackMarvelsApp.ipa
          issuer-id: ${{ secrets.APPLE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPLE_KEY_ID }}
          api-private-key: ${{ secrets.APPLE_PRIVATE_KEY }}
          skip-waiting-for-build-processing: ${{ github.event.inputs.skip_waiting_for_build_processing }}

      - name: Build Summary
        run: |
          echo "## iOS Build & Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Signing:** ${{ steps.setup_signing.outputs.signing_enabled == 'true' && 'âœ… Enabled' || 'âŒ Disabled' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.validate_appstore_credentials.outputs.publish_enabled }}" == "true" ] && [ "${{ steps.setup_signing.outputs.signing_enabled }}" == "true" ]; then
            echo "### âœ… Published to App Store Connect (TestFlight)" >> $GITHUB_STEP_SUMMARY
            echo "- Check [App Store Connect](https://appstoreconnect.apple.com) for build status" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“¦ Manual Upload Required" >> $GITHUB_STEP_SUMMARY
            echo "1. Download the archive/IPA from artifacts" >> $GITHUB_STEP_SUMMARY
            echo "2. Go to [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
            echo "3. Upload the build using Transporter or Xcode" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.setup_signing.outputs.signing_enabled }}" != "true" ]; then
              echo "**Code Signing:** Configure \`APPLE_CERTIFICATE_BASE64\` and \`APPLE_PROVISIONING_PROFILE_BASE64\` secrets." >> $GITHUB_STEP_SUMMARY
            fi
            if [ "${{ steps.validate_appstore_credentials.outputs.publish_enabled }}" != "true" ]; then
              echo "**App Store Connect:** Configure \`APPLE_ISSUER_ID\`, \`APPLE_KEY_ID\`, and \`APPLE_PRIVATE_KEY\` secrets." >> $GITHUB_STEP_SUMMARY
            fi
            echo "See \`STORE_PUBLISHING_SETUP.md\` for detailed instructions." >> $GITHUB_STEP_SUMMARY
          fi
